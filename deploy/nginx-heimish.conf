# Frontend + Directus CMS
server {
    server_name heimish.ru www.heimish.ru 130.49.148.62;

    root /var/www/heimish.ru;
    index index.html;

    # Directus Admin Panel
    location ^~ /admin {
        proxy_pass http://127.0.0.1:8055;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Directus API via /directus prefix (for frontend JS)
    location /directus/ {
        proxy_pass http://127.0.0.1:8055/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 50M;
    }

    # Directus internal endpoints (needed by admin panel)
    location /auth/ {
        proxy_pass http://127.0.0.1:8055/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /users/ {
        proxy_pass http://127.0.0.1:8055/users/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /users {
        proxy_pass http://127.0.0.1:8055/users;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /roles {
        proxy_pass http://127.0.0.1:8055/roles;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /policies {
        proxy_pass http://127.0.0.1:8055/policies;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /permissions {
        proxy_pass http://127.0.0.1:8055/permissions;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /items/ {
        proxy_pass http://127.0.0.1:8055/items/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /collections {
        proxy_pass http://127.0.0.1:8055/collections;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /fields {
        proxy_pass http://127.0.0.1:8055/fields;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /relations {
        proxy_pass http://127.0.0.1:8055/relations;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /activity {
        proxy_pass http://127.0.0.1:8055/activity;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /presets {
        proxy_pass http://127.0.0.1:8055/presets;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /settings {
        proxy_pass http://127.0.0.1:8055/settings;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /files {
        proxy_pass http://127.0.0.1:8055/files;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 50M;
    }

    location /folders {
        proxy_pass http://127.0.0.1:8055/folders;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /notifications {
        proxy_pass http://127.0.0.1:8055/notifications;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /translations {
        proxy_pass http://127.0.0.1:8055/translations;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /dashboards {
        proxy_pass http://127.0.0.1:8055/dashboards;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /panels {
        proxy_pass http://127.0.0.1:8055/panels;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /flows {
        proxy_pass http://127.0.0.1:8055/flows;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /operations {
        proxy_pass http://127.0.0.1:8055/operations;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /extensions/ {
        proxy_pass http://127.0.0.1:8055/extensions/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /server/ {
        proxy_pass http://127.0.0.1:8055/server/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /schema {
        proxy_pass http://127.0.0.1:8055/schema;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /utils {
        proxy_pass http://127.0.0.1:8055/utils;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /versions {
        proxy_pass http://127.0.0.1:8055/versions;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /comments {
        proxy_pass http://127.0.0.1:8055/comments;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /shares {
        proxy_pass http://127.0.0.1:8055/shares;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /revisions {
        proxy_pass http://127.0.0.1:8055/revisions;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Frontend static assets (must be BEFORE SPA fallback)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf|webp)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # SPA fallback - serves index.html for all other routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/heimish.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/heimish.ru/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    listen 80;
    server_name heimish.ru www.heimish.ru 130.49.148.62;
    return 301 https://heimish.ru$request_uri;
}
